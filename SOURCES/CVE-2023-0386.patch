From 49fc47e81624d594ff10837b9cd34f14c9e26046 Mon Sep 17 00:00:00 2001
From: Ryan Sullivan <rysulliv@redhat.com>
Date: Wed, 15 Mar 2023 09:20:36 -0400
Subject: [KPATCH CVE-2023-0386] kpatch fixes for CVE-2023-0386

Kernels:
4.18.0-425.3.1.el8
4.18.0-425.10.1.el8_7
4.18.0-425.13.1.el8_7


Kpatch-MR: https://gitlab.com/redhat/prdsc/rhel/src/kpatch/rhel-8/-/merge_requests/92
Approved-by: Joe Lawrence (@joe.lawrence)
Approved-by: Yannick Cote (@ycote1)
Changes since last build:
[x86_64]:
copy_up.o: changed function: ovl_copy_up_one
copy_up.o: new function: ovl_do_copy_up

[ppc64le]:
copy_up.o: changed function: ovl_copy_up_one

---------------------------

Modifications: none

commit a9ae1a96322125120bbb5177b1c76586f886a8db
Author: Miklos Szeredi <mszeredi@redhat.com>
Date:   Tue Jan 24 16:41:18 2023 +0100

    ovl: fail on invalid uid/gid mapping at copy up

    Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=2165341
    CVE: CVE-2023-0386

    If st_uid/st_gid doesn't have a mapping in the mounter's user_ns, then
    copy-up should fail, just like it would fail if the mounter task was doing
    the copy using "cp -a".

    There's a corner case where the "cp -a" would succeed but copy up fail: if
    there's a mapping of the invalid uid/gid (65534 by default) in the user
    namespace.  This is because stat(2) will return this value if the mapping
    doesn't exist in the current user_ns and "cp -a" will in turn be able to
    create a file with this uid/gid.

    This behavior would be inconsistent with POSIX ACL's, which return -1 for
    invalid uid/gid which result in a failed copy.

    For consistency and simplicity fail the copy of the st_uid/st_gid are
    invalid.

    Fixes: 459c7c565ac3 ("ovl: unprivieged mounts")
    Cc: <stable@vger.kernel.org> # v5.11
    Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
    Reviewed-by: Christian Brauner <brauner@kernel.org>
    Reviewed-by: Seth Forshee <sforshee@kernel.org>
    (cherry picked from commit 4f11ada10d0ad3fd53e2bd67806351de63a4f9c3)

    Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>

Signed-off-by: Ryan Sullivan <rysulliv@redhat.com>
---
 fs/overlayfs/copy_up.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/fs/overlayfs/copy_up.c b/fs/overlayfs/copy_up.c
index edd818b77aac..7c51ca835fc7 100644
--- a/fs/overlayfs/copy_up.c
+++ b/fs/overlayfs/copy_up.c
@@ -889,6 +889,10 @@ static int ovl_copy_up_one(struct dentry *parent, struct dentry *dentry,
 	if (err)
 		return err;
 
+	if (!kuid_has_mapping(current_user_ns(), ctx.stat.uid) ||
+	    !kgid_has_mapping(current_user_ns(), ctx.stat.gid))
+		return -EOVERFLOW;
+
 	ctx.metacopy = ovl_need_meta_copy_up(dentry, ctx.stat.mode, flags);
 
 	if (parent) {
-- 
2.39.2


